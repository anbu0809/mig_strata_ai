<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strata Backend Engine Integration Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        button {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #4338ca;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        input, select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 100%;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .connection-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9fafb;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
        .info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .hidden {
            display: none;
        }
        .action-buttons {
            margin-top: 10px;
        }
        .action-buttons button {
            padding: 5px 10px;
            font-size: 14px;
        }
        .edit-btn {
            background-color: #f59e0b;
        }
        .edit-btn:hover {
            background-color: #d97706;
        }
        .delete-btn {
            background-color: #ef4444;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <h1>Strata Backend Engine Integration Example</h1>
    
    <div class="container">
        <h2>Backend Connection</h2>
        <div id="backend-status" class="status info">
            Checking backend connection...
        </div>
    </div>
    
    <div class="container">
        <h2 id="form-title">Add Database Connection</h2>
        <div>
            <label>Connection Name:</label>
            <input type="text" id="connection-name" placeholder="My Database Connection">
        </div>
        
        <div>
            <label>Database Type:</label>
            <select id="database-type">
                <option value="PostgreSQL">PostgreSQL</option>
                <option value="MySQL">MySQL</option>
                <option value="Snowflake">Snowflake</option>
                <option value="Databricks">Databricks</option>
                <option value="Oracle">Oracle</option>
                <option value="SQL Server">SQL Server</option>
                <option value="Teradata">Teradata</option>
                <option value="Google BigQuery">Google BigQuery</option>
            </select>
        </div>
        
        <div id="credential-fields">
            <!-- Credential fields will be dynamically added here -->
        </div>
        
        <button id="test-connection">Test Connection</button>
        <button id="save-connection" disabled>Save Connection</button>
        <button id="cancel-edit" style="display: none;">Cancel</button>
        
        <div id="test-result" class="status hidden"></div>
    </div>
    
    <div class="container">
        <h2>Saved Connections</h2>
        <button id="refresh-connections">Refresh Connections</button>
        <div id="connections-list">
            <!-- Connections will be listed here -->
        </div>
    </div>
    
    <script>
        // Backend URL - update this to match your backend deployment
        const BACKEND_URL = 'http://localhost:8000';
        
        // DOM Elements
        const backendStatusEl = document.getElementById('backend-status');
        const connectionNameEl = document.getElementById('connection-name');
        const databaseTypeEl = document.getElementById('database-type');
        const credentialFieldsEl = document.getElementById('credential-fields');
        const testConnectionBtn = document.getElementById('test-connection');
        const saveConnectionBtn = document.getElementById('save-connection');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const testResultEl = document.getElementById('test-result');
        const refreshConnectionsBtn = document.getElementById('refresh-connections');
        const connectionsListEl = document.getElementById('connections-list');
        const formTitleEl = document.getElementById('form-title');
        
        // Credential field definitions
        const credentialFields = {
            'PostgreSQL': [
                { name: 'host', label: 'Host', type: 'text' },
                { name: 'port', label: 'Port', type: 'number' },
                { name: 'database', label: 'Database', type: 'text' },
                { name: 'username', label: 'Username', type: 'text' },
                { name: 'password', label: 'Password', type: 'password' },
                { name: 'sslmode', label: 'SSL Mode', type: 'select', options: ['disable', 'require'] }
            ],
            'MySQL': [
                { name: 'host', label: 'Host', type: 'text' },
                { name: 'port', label: 'Port', type: 'number' },
                { name: 'database', label: 'Database', type: 'text' },
                { name: 'username', label: 'Username', type: 'text' },
                { name: 'password', label: 'Password', type: 'password' },
                { name: 'ssl', label: 'SSL', type: 'select', options: ['false', 'true'] }
            ],
            'Snowflake': [
                { name: 'account', label: 'Account', type: 'text' },
                { name: 'user', label: 'User', type: 'text' },
                { name: 'password', label: 'Password', type: 'password' },
                { name: 'role', label: 'Role (Optional)', type: 'text' },
                { name: 'warehouse', label: 'Warehouse', type: 'text' },
                { name: 'database', label: 'Database', type: 'text' },
                { name: 'schema', label: 'Schema', type: 'text' }
            ],
            'Databricks': [
                { name: 'server_hostname', label: 'Server Hostname', type: 'text' },
                { name: 'http_path', label: 'HTTP Path', type: 'text' },
                { name: 'access_token', label: 'Access Token', type: 'password' },
                { name: 'catalog', label: 'Catalog (Optional)', type: 'text' },
                { name: 'schema', label: 'Schema (Optional)', type: 'text' }
            ],
            'Oracle': [
                { name: 'host', label: 'Host', type: 'text' },
                { name: 'port', label: 'Port', type: 'number' },
                { name: 'service_name', label: 'Service Name', type: 'text' },
                { name: 'username', label: 'Username', type: 'text' },
                { name: 'password', label: 'Password', type: 'password' }
            ],
            'SQL Server': [
                { name: 'host', label: 'Host', type: 'text' },
                { name: 'port', label: 'Port', type: 'number' },
                { name: 'database', label: 'Database', type: 'text' },
                { name: 'username', label: 'Username', type: 'text' },
                { name: 'password', label: 'Password', type: 'password' },
                { name: 'driver', label: 'Driver', type: 'text' }
            ],
            'Teradata': [
                { name: 'host', label: 'Host', type: 'text' },
                { name: 'username', label: 'Username', type: 'text' },
                { name: 'password', label: 'Password', type: 'password' },
                { name: 'database', label: 'Database (Optional)', type: 'text' }
            ],
            'Google BigQuery': [
                { name: 'project_id', label: 'Project ID', type: 'text' },
                { name: 'dataset', label: 'Dataset (Optional)', type: 'text' },
                { name: 'credentials_json', label: 'Credentials JSON', type: 'textarea' }
            ]
        };
        
        // Current test result and edit state
        let currentTestResult = null;
        let editingConnectionId = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check backend connection
            checkBackendConnection();
            
            // Set up event listeners
            databaseTypeEl.addEventListener('change', updateCredentialFields);
            testConnectionBtn.addEventListener('click', testConnection);
            saveConnectionBtn.addEventListener('click', saveConnection);
            cancelEditBtn.addEventListener('click', cancelEdit);
            refreshConnectionsBtn.addEventListener('click', fetchConnections);
            
            // Initialize credential fields
            updateCredentialFields();
            
            // Fetch initial connections
            fetchConnections();
        });
        
        // Check backend connection
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/connections`);
                if (response.ok) {
                    backendStatusEl.className = 'status success';
                    backendStatusEl.textContent = 'Backend connected successfully!';
                } else {
                    throw new Error('Backend returned error status');
                }
            } catch (error) {
                backendStatusEl.className = 'status error';
                backendStatusEl.textContent = 'Failed to connect to backend. Make sure the backend server is running.';
            }
        }
        
        // Update credential fields based on selected database type
        function updateCredentialFields() {
            const dbType = databaseTypeEl.value;
            const fields = credentialFields[dbType] || [];
            
            credentialFieldsEl.innerHTML = '';
            
            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                
                const label = document.createElement('label');
                label.textContent = field.label;
                fieldDiv.appendChild(label);
                
                if (field.type === 'select') {
                    const select = document.createElement('select');
                    select.id = `cred-${field.name}`;
                    
                    field.options.forEach(option => {
                        const optionEl = document.createElement('option');
                        optionEl.value = option;
                        optionEl.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                        select.appendChild(optionEl);
                    });
                    
                    fieldDiv.appendChild(select);
                } else if (field.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.id = `cred-${field.name}`;
                    textarea.rows = 4;
                    fieldDiv.appendChild(textarea);
                } else {
                    const input = document.createElement('input');
                    input.type = field.type;
                    input.id = `cred-${field.name}`;
                    fieldDiv.appendChild(input);
                }
                
                credentialFieldsEl.appendChild(fieldDiv);
            });
        }
        
        // Collect credentials from form fields
        function collectCredentials() {
            const dbType = databaseTypeEl.value;
            const fields = credentialFields[dbType] || [];
            const credentials = {};
            
            fields.forEach(field => {
                const element = document.getElementById(`cred-${field.name}`);
                if (element) {
                    credentials[field.name] = element.value;
                }
            });
            
            return credentials;
        }
        
        // Populate form with existing connection data
        function populateForm(connection) {
            connectionNameEl.value = connection.name;
            databaseTypeEl.value = connection.dbType;
            updateCredentialFields();
            
            // Populate credential fields
            setTimeout(() => {
                Object.keys(connection.credentials).forEach(key => {
                    const element = document.getElementById(`cred-${key}`);
                    if (element) {
                        element.value = connection.credentials[key];
                    }
                });
            }, 100);
        }
        
        // Test database connection
        async function testConnection() {
            const connectionName = connectionNameEl.value;
            const dbType = databaseTypeEl.value;
            const credentials = collectCredentials();
            
            if (!connectionName) {
                showTestResult('error', 'Please enter a connection name');
                return;
            }
            
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'Testing...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/connections/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: connectionName,
                        dbType: dbType,
                        credentials: credentials
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showTestResult('success', `Connection successful! ${result.details}`);
                    currentTestResult = { ok: true, dbType, name: connectionName, credentials };
                    saveConnectionBtn.disabled = false;
                } else {
                    showTestResult('error', `Connection failed: ${result.details}`);
                    currentTestResult = null;
                    saveConnectionBtn.disabled = true;
                }
            } catch (error) {
                showTestResult('error', 'Failed to test connection: ' + error.message);
                currentTestResult = null;
                saveConnectionBtn.disabled = true;
            } finally {
                testConnectionBtn.disabled = false;
                testConnectionBtn.textContent = 'Test Connection';
            }
        }
        
        // Save database connection
        async function saveConnection() {
            if (!currentTestResult || !currentTestResult.ok) {
                showTestResult('error', 'Please test the connection first');
                return;
            }
            
            saveConnectionBtn.disabled = true;
            saveConnectionBtn.textContent = 'Saving...';
            
            try {
                const endpoint = editingConnectionId 
                    ? `${BACKEND_URL}/api/connections/${editingConnectionId}` 
                    : `${BACKEND_URL}/api/connections/save`;
                
                const method = editingConnectionId ? 'PUT' : 'POST';
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: currentTestResult.name,
                        dbType: currentTestResult.dbType,
                        credentials: currentTestResult.credentials
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showTestResult('success', editingConnectionId 
                        ? 'Connection updated successfully!' 
                        : 'Connection saved successfully!');
                    
                    currentTestResult = null;
                    saveConnectionBtn.disabled = true;
                    editingConnectionId = null;
                    
                    // Reset form
                    resetForm();
                    
                    // Refresh connections list
                    fetchConnections();
                } else {
                    showTestResult('error', editingConnectionId 
                        ? 'Failed to update connection' 
                        : 'Failed to save connection');
                }
            } catch (error) {
                showTestResult('error', editingConnectionId 
                    ? 'Failed to update connection: ' + error.message 
                    : 'Failed to save connection: ' + error.message);
            } finally {
                saveConnectionBtn.disabled = false;
                saveConnectionBtn.textContent = editingConnectionId ? 'Update Connection' : 'Save Connection';
            }
        }
        
        // Edit a connection
        async function editConnection(id) {
            try {
                // Fetch connection details
                const response = await fetch(`${BACKEND_URL}/api/connections/${id}`);
                if (response.ok) {
                    const connection = await response.json();
                    
                    // Populate form with connection data
                    populateForm(connection);
                    
                    // Set edit state
                    editingConnectionId = id;
                    formTitleEl.textContent = 'Edit Database Connection';
                    saveConnectionBtn.textContent = 'Update Connection';
                    cancelEditBtn.style.display = 'inline-block';
                    
                    // Scroll to form
                    document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Failed to fetch connection details');
                }
            } catch (error) {
                alert('Failed to fetch connection details: ' + error.message);
            }
        }
        
        // Cancel edit
        function cancelEdit() {
            editingConnectionId = null;
            resetForm();
            formTitleEl.textContent = 'Add Database Connection';
            saveConnectionBtn.textContent = 'Save Connection';
            cancelEditBtn.style.display = 'none';
        }
        
        // Reset form
        function resetForm() {
            connectionNameEl.value = '';
            databaseTypeEl.value = 'PostgreSQL';
            updateCredentialFields();
            showTestResult('hidden', '');
            currentTestResult = null;
            saveConnectionBtn.disabled = true;
        }
        
        // Show test result message
        function showTestResult(type, message) {
            testResultEl.className = `status ${type} ${type === 'hidden' ? 'hidden' : ''}`;
            testResultEl.textContent = message;
        }
        
        // Fetch and display connections
        async function fetchConnections() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/connections`);
                if (response.ok) {
                    const connections = await response.json();
                    displayConnections(connections);
                } else {
                    connectionsListEl.innerHTML = '<p class="error">Failed to fetch connections</p>';
                }
            } catch (error) {
                connectionsListEl.innerHTML = `<p class="error">Failed to fetch connections: ${error.message}</p>`;
            }
        }
        
        // Display connections in the list
        function displayConnections(connections) {
            if (connections.length === 0) {
                connectionsListEl.innerHTML = '<p>No connections saved yet.</p>';
                return;
            }
            
            connectionsListEl.innerHTML = '';
            
            connections.forEach(connection => {
                const card = document.createElement('div');
                card.className = 'connection-card';
                card.innerHTML = `
                    <h3>${connection.name}</h3>
                    <p><strong>Type:</strong> ${connection.dbType}</p>
                    <p><strong>ID:</strong> ${connection.id}</p>
                    <div class="action-buttons">
                        <button onclick="editConnection(${connection.id})" class="edit-btn">Edit</button>
                        <button onclick="deleteConnection(${connection.id})" class="delete-btn">Delete</button>
                    </div>
                `;
                connectionsListEl.appendChild(card);
            });
        }
        
        // Delete a connection
        async function deleteConnection(id) {
            if (!confirm('Are you sure you want to delete this connection?')) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/connections/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Connection deleted successfully!');
                    fetchConnections();
                } else {
                    alert('Failed to delete connection');
                }
            } catch (error) {
                alert('Failed to delete connection: ' + error.message);
            }
        }
        
        // Make functions available globally for onclick handlers
        window.editConnection = editConnection;
        window.deleteConnection = deleteConnection;
    </script>
</body>
</html>